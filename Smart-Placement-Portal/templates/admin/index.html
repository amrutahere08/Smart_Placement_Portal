{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-md-4">
                <a href="{{ url_for('admin_students', filter='all') }}" style="text-decoration: none;">
                    <div class="glass-panel p-3 text-center h-100 card-hover">
                        <h5 class="text-white-50">Total Students</h5>
                        <h2 class="text-white">{{ stats.students }}</h2>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('admin_students', filter='placed') }}" style="text-decoration: none;">
                    <div class="glass-panel p-3 text-center h-100 card-hover">
                        <h5 class="text-white-50">Placed Students</h5>
                        <h2 class="text-success">{{ stats.placed }}</h2>
                    </div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('admin_drives') }}" style="text-decoration: none;">
                    <div class="glass-panel p-3 text-center h-100 card-hover">
                        <h5 class="text-white-50">Total Drives</h5>
                        <h2 class="text-primary">{{ stats.companies }}</h2>
                    </div>
                </a>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="glass-panel p-3">
                    <h5 class="text-white mb-3">Placement by Branch</h5>
                    <canvas id="branchChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-panel p-3">
                    <h5 class="text-white mb-3">Top Recruiting Companies</h5>
                    <canvas id="compChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Feed Section -->
            <div class="col-md-7 mb-4">
                <div class="glass-panel p-4 h-100">
                    <h2 class="mb-4">Live Updates</h2>
                    <form action="{{ url_for('post_feed') }}" method="POST" class="mb-5">
                        <div class="form-group">
                            <textarea class="form-control" rows="3" name="message" placeholder="Post an announcement..."
                                required></textarea>
                        </div>
                        <button type="submit" name="post" class="btn btn-primary-custom btn-sm">Post Update</button>
                    </form>

                    <div class="feed-list" style="max-height: 50vh; overflow-y: auto;">
                        {% if feed_items %}
                        {% for row in feed_items %}
                        <div class="feed-card">
                            <div class="feed-header">
                                <i class="far fa-user-circle fa-2x" style="color: var(--secondary);"></i>
                                <span class="feed-user">{{ row.user }}</span>
                                <span class="ml-auto text-muted small">{{ row.date }}</span>
                            </div>
                            <p class="mb-0 text-white">{{ row.message }}</p>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-center text-muted">No updates yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Company List Section -->
            <div class="col-md-5 mb-4">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">Recruitment Drives</h2>
                        <a href="{{ url_for('manage_company') }}" class="btn btn-primary-custom btn-sm">+ Add</a>
                    </div>

                    <div class="company-list" style="max-height: 60vh; overflow-y: auto;">
                        {% if companies %}
                        {% for comp in companies %}
                        <div class="card mb-3"
                            style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);">
                            <div class="card-body">
                                <h5 class="card-title text-white mb-2">{{ comp.name }}</h5>
                                <p class="card-text small text-muted mb-1"><strong>Date:</strong> {{ comp.curdate }} |
                                    <strong>Role:</strong> {{ comp.det }}</p>
                                <p class="card-text small text-muted mb-3"><strong>Criteria:</strong> 10th: {{
                                    comp.tenth }}% | 12th: {{ comp.twelth }}%</p>

                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('view_applicants', company_id=comp.id) }}"
                                        class="btn btn-sm btn-outline-light flex-grow-1 mr-2">
                                        View Applications
                                    </a>
                                    <a href="{{ url_for('delete_company', id=comp.id) }}"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Are you sure you want to delete {{ comp.name }}?');">
                                        Delete
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-center text-muted">No companies added yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Branch Chart
    const ctxBranch = document.getElementById('branchChart').getContext('2d');
    new Chart(ctxBranch, {
        type: 'doughnut',
        data: {
            labels: {{ stats.branch_labels | tojson }},
        datasets: [{
            data: {{ stats.branch_counts | tojson }},
        backgroundColor: ['#a400ff', '#00ffe1', '#ff0055', '#ffe600', '#0099ff'],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { position: 'right', labels: { color: 'white' } }
        }
    }
    });

    // Company Chart
    const ctxComp = document.getElementById('compChart').getContext('2d');
    new Chart(ctxComp, {
        type: 'bar',
        data: {
            labels: {{ stats.comp_labels | tojson }},
        datasets: [{
            label: 'Applications',
            data: {{ stats.comp_counts | tojson }},
        backgroundColor: '#00ffe1',
        borderRadius: 5
            }]
        },
        options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: 'white' }, grid: { display: false } }
        }
    }
    });
</script>
{% endblock %}